apiVersion: batch/v1
kind: Job
metadata:
  name: vault-config
  namespace: vault
spec:
  template:
    spec:
      serviceAccountName: vault-config
      restartPolicy: OnFailure
      containers:
      - name: vault-config
        image: hashicorp/vault:1.15
        env:
        - name: VAULT_ADDR
          value: "http://vault.vault.svc.cluster.local:8200"
        - name: VAULT_TOKEN
          value: "root"
        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "Waiting for Vault to be ready..."
          until vault status; do
            echo "Vault not ready, waiting..."
            sleep 2
          done

          echo "Configuring Kubernetes auth backend..."

          # Enable Kubernetes auth if not already enabled
          vault auth enable kubernetes 2>/dev/null || echo "Kubernetes auth already enabled"

          # Get Kubernetes host
          KUBERNETES_HOST="https://kubernetes.default.svc"

          # Configure Kubernetes auth
          vault write auth/kubernetes/config \
            kubernetes_host="$KUBERNETES_HOST"

          # Create policy for external-secrets
          vault policy write external-secrets - <<EOF
          path "secret/data/*" {
            capabilities = ["read", "list"]
          }
          path "secret/metadata/*" {
            capabilities = ["read", "list"]
          }
          EOF

          # Create role for external-secrets
          vault write auth/kubernetes/role/external-secrets \
            bound_service_account_names=external-secrets \
            bound_service_account_namespaces=external-secrets \
            policies=external-secrets \
            ttl=24h

          echo "Vault configuration completed successfully!"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-config
  namespace: vault
